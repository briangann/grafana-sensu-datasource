{"version":3,"sources":["../src/aggregate_functions.js"],"names":["getAggregateURIs","target","aggregateNames","URIs","dimensionURI","anAggregateName","length","i","aggregateMode","push","convertAggregatesToDataPoints","aTarget","responses","response","getResponseForTarget","data","undefined","singleData","newData","anEvent","checks","checkType","convertEventDataToAggregateModeList","convertEventDataToAggregateModeClient","clients","convertEventDataToAggregateModeChecks","summary","convertEventDataToAggregateModeResults","datapoints","timestamp","Math","floor","Date","now","name","dataSet","aSummary","checkData","check","total","clientName","checkName","clientData","item","results","critical","ok","stale","unknown","warning","convertToAggregateModeClientJSON","convertAggregatesToJSON","aggregateName","dimensions","value","client","aggregate_name","type"],"mappings":"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","file":"aggregate_functions.js","sourcesContent":["/**\n *\n */\n\nfunction getAggregateURIs(target, aggregateNames) {\n  // https://sensuapp.org/docs/0.28/api/aggregates-api.html\n  var URIs = [];\n  var dimensionURI = '/aggregates';\n  var anAggregateName = null;\n  // name, name/clients, name/checks, name/results/severity\n  if (aggregateNames.length) {\n    for (let i = 0; i < aggregateNames.length; i++) {\n      anAggregateName = aggregateNames[i];\n      dimensionURI = '/aggregates/' + anAggregateName;\n      switch (target.aggregateMode) {\n        case 'checks':\n          dimensionURI = '/aggregates/' + anAggregateName + '/checks';\n          break;\n        case 'clients':\n          dimensionURI = '/aggregates/' + anAggregateName + '/clients';\n          break;\n        case 'list':\n          dimensionURI = '/aggregates/' + anAggregateName;\n          break;\n        case 'results_critical':\n          dimensionURI = '/aggregates/' + anAggregateName + '/results/critical';\n          break;\n        case 'results_ok':\n          dimensionURI = '/aggregates/' + anAggregateName + '/results/ok';\n          break;\n        case 'results_unknown':\n          dimensionURI = '/aggregates/' + anAggregateName + '/results/unknown';\n          break;\n        case 'results_warning':\n          dimensionURI = '/aggregates/' + anAggregateName + '/results/warning';\n          break;\n      }\n      URIs.push(dimensionURI);\n    }\n  }\n  if (URIs.length === 0) {\n    URIs.push(dimensionURI);\n  }\n  return URIs;\n}\n\n/**\n * [convertAggregatesToDataPoints description]\n * @param  {[type]} response [description]\n * @return {[type]}        [description]\n */\nfunction convertAggregatesToDataPoints(aTarget, responses) {\n  var response = getResponseForTarget(aTarget, responses);\n  // the result has no \"datapoints\", need to create it based on the check data\n\n  // when we have a checkname and an clientName, the response is different, the\n  // data is not an array, but contains the same information, recreate and push\n  if (response.data.length === undefined) {\n    var singleData = response.data;\n    response.data = [];\n    response.data.push(singleData);\n  }\n  // storage for new data series constructed by aggregate responses\n  var newData = null;\n  for (var i = 0; i < response.data.length; i++) {\n    var anEvent = response.data[i];\n    // checks is defined when the aggregate mode is either \"Clients\" or \"List\"\n    if (anEvent.checks !== undefined) {\n      // create a new block of datapoints for each aggregate result json entry\n      //\n      var checkType = typeof(anEvent.checks);\n      switch (checkType) {\n        case 'number':\n          // checksType is a number, which is an aggregate list response\n          newData = convertEventDataToAggregateModeList(anEvent, newData);\n          break;\n        case 'object':\n          // checkType is an object, which is an aggregate clients response\n          newData = convertEventDataToAggregateModeClient(anEvent, newData);\n          break;\n      }\n      continue;\n    }\n    // clients is defined when the aggregate mode is \"Checks\"\n    if (anEvent.clients !== undefined) {\n      newData = convertEventDataToAggregateModeChecks(anEvent, newData);\n      continue;\n    }\n    // summary is defined when the aggregate mode is \"Results OK/WARNING/CRITICAL/UNKNOWN\"\n    if (anEvent.summary !== undefined) {\n      newData = convertEventDataToAggregateModeResults(anEvent, newData);\n      continue;\n    }\n\n    // this is a simple aggregate response (no mode)\n    var datapoints = [];\n    // timestamp is the query now (just use now)\n    var timestamp = Math.floor(Date.now());\n    datapoints[0] = [0, timestamp];\n    anEvent.datapoints = datapoints;\n    // set the target to be the name of the aggregate\n    anEvent.target = anEvent.name;\n  }\n  if (newData !== null) {\n    // overwrite the old data field with the new expanded set\n    response.data = newData;\n  }\n  return response;\n}\n\nfunction convertEventDataToAggregateModeResults(anEvent, dataSet) {\n  var timestamp = Math.floor(Date.now());\n  if (dataSet === null) {\n    // initialize empty array\n    dataSet = [];\n  }\n  // iterate over the checks\n  for (var i = 0; i < anEvent.summary.length; i++) {\n    var aSummary = anEvent.summary[i];\n    var checkData = {\n      target: anEvent.check,\n      clients: aSummary.clients,\n      datapoints: [\n        [aSummary.total, timestamp]\n      ]\n    };\n    dataSet.push(checkData);\n  }\n  return dataSet;\n}\n// An aggregate checks result has the format\n// {\n//    clients: [\n//      clientName\n//    ],\n//    name: checkName\n// }\nfunction convertEventDataToAggregateModeChecks(anEvent, dataSet) {\n  var timestamp = Math.floor(Date.now());\n  if (dataSet === null) {\n    // initialize empty array\n    dataSet = [];\n  }\n  // iterate over the checks\n  for (var i = 0; i < anEvent.clients.length; i++) {\n    var clientName = anEvent.clients[i];\n    var checkData = {\n      target: anEvent.name,\n      datapoints: [\n        [clientName, timestamp]\n      ]\n    };\n    dataSet.push(checkData);\n  }\n  return dataSet;\n}\n\n// An aggregate clients result has the format\n// {\n//    checks: [\n//      checkName\n//    ],\n//    name: clientName\n// }\nfunction convertEventDataToAggregateModeClient(anEvent, dataSet) {\n  var timestamp = Math.floor(Date.now());\n  if (dataSet === null) {\n    // initialize empty array\n    dataSet = [];\n  }\n  // iterate over the checks\n  for (var i = 0; i < anEvent.checks.length; i++) {\n    var checkName = anEvent.checks[i];\n    var clientData = {\n      target: anEvent.name,\n      datapoints: [\n        [checkName, timestamp]\n      ]\n    };\n    dataSet.push(clientData);\n  }\n  return dataSet;\n}\n// An aggregate list result has the format\n// {\n//   checks: int,\n//   clients: int,\n//   results: {\n//    critical: int,\n//    ok: int,\n//    stale: int,\n//    total: int,\n//    unknown: int,\n//    warning: int\n//   }\n// }\nfunction convertEventDataToAggregateModeList(anEvent, dataSet) {\n  if (dataSet === null) {\n    // initialize empty array\n    dataSet = [];\n  }\n  var timestamp = Math.floor(Date.now());\n  var item = {\n    target: 'checks',\n    datapoints: [\n      [anEvent.checks, timestamp]\n    ]\n  };\n  dataSet.push(item);\n  item = {\n    target: 'clients',\n    datapoints: [\n      [anEvent.clients, timestamp]\n    ]\n  };\n  dataSet.push(item);\n  item = {\n    target: 'critical',\n    datapoints: [\n      [anEvent.results.critical, timestamp]\n    ]\n  };\n  dataSet.push(item);\n  item = {\n    target: 'ok',\n    datapoints: [\n      [anEvent.results.ok, timestamp]\n    ]\n  };\n  dataSet.push(item);\n  item = {\n    target: 'stale',\n    datapoints: [\n      [anEvent.results.stale, timestamp]\n    ]\n  };\n  dataSet.push(item);\n  item = {\n    target: 'total',\n    datapoints: [\n      [anEvent.results.total, timestamp]\n    ]\n  };\n  dataSet.push(item);\n  item = {\n    target: 'unknown',\n    datapoints: [\n      [anEvent.results.unknown, timestamp]\n    ]\n  };\n  dataSet.push(item);\n  item = {\n    target: 'warning',\n    datapoints: [\n      [anEvent.results.warning, timestamp]\n    ]\n  };\n  dataSet.push(item);\n\n  return dataSet;\n}\n\nfunction convertToAggregateModeClientJSON(data, dataSet) {\n  //debugger;\n  var timestamp = Math.floor(Date.now());\n  if (dataSet === null) {\n    // initialize empty array\n    dataSet = [];\n  }\n  // iterate over the checks\n  for (var i = 0; i < data.checks.length; i++) {\n    var checkName = data.checks[i];\n    var clientData = {\n      target: data.name,\n      datapoints: [\n        [checkName, timestamp]\n      ]\n    };\n    dataSet.push(clientData);\n  }\n  return dataSet;\n}\n\n\n/**\n * [convertAggregatesToJSON description]\n * @param  {[type]} response [description]\n * @param  {[type]} aTarget  [description]\n * @return {[type]}          [description]\n */\nfunction convertAggregatesToJSON(aTarget, responses) {\n  var response = getResponseForTarget(aTarget, responses);\n  var aggregateName = \"ALL\";\n  if (aTarget.dimensions.length > 0) {\n    aggregateName = aTarget.dimensions[0].value;\n  }\n  for (var i = 0; i < response.data.length; i++) {\n    var item = response.data[i];\n    var datapoints = [];\n    var data = {\n      client: item.name,\n      checks: item.checks,\n      aggregate_name: aggregateName,\n    };\n    datapoints.push(data);\n    item.datapoints = datapoints;\n    item.type = 'docs';\n  }\n  return response;\n}\n\n\n\nexport {\n  getAggregateURIs,\n  convertAggregatesToDataPoints,\n  convertAggregatesToJSON\n};\n"]}